# Публичное Rest API (28-05-2022)
<!-- TOC -->

- [1. Общая информация](#1-общая-информация)
- [2. Коды возврата HTTP](#2-коды-возврата-http)
- [3. Коды ошибок](#3-коды-ошибок)
- [4. Лимиты](#4-лимиты)
    - [4.1. Частные лимиты](#41-частные-лимиты)
- [5. Аутентификация запросов](#5-аутентификация-запросов)
- [6. Определения объектов API](#6-определения-объектов-api)
    - [6.1. Объект заказа](#61-объект-заказа)
    - [6.2. Статус заказа](#62-статус-заказа)
- [7. Методы API](#7-методы-api)
    - [7.1. Забронировать место для размещения заказа](#71-забронировать-место-для-размещения-заказа)
    - [7.2. Отменить размещение заказа](#72-отменить-размещение-заказа)
    - [7.3. Забронировать место для возврата заказа](#73-забронировать-место-для-возврата-заказа)
    - [7.4. Отменить возврат](#74-отменить-возврат)
    - [7.5. Получить информацию о заказе](#75-получить-информацию-о-заказе)
    - [7.6. Получить историю статусов заказа](#76-получить-историю-статусов-заказа)
    - [7.7. Получить список заказов](#77-получить-список-заказов)

<!-- /TOC -->

## 1. Общая информация

- Базовая точка доступа для API: **<https://api.capsula24.com/>**
- В ответе всегда возвращается объект `JSON`
- Для `GET` запросов параметры должны быть отправлены как `query string`.
- Для `POST`, `PUT`, and `DELETE` запросов параметры должны быть отправлены в теле запроса как JSON объект.
- Параметры могут быть отправлены в любом порядке.

## 2. Коды возврата HTTP

Описание возможных кодов возврата HTTP

- HTTP `401` Источник запроса не авторизован
- HTTP `4XX` используются для некорректных запросов, когда отправитель неверно его сформировал.
- HTTP `429` используется при достижении лимита по частоте запросов.
- HTTP `5XX` используется при проблемах на стороне API.

## 3. Коды ошибок

В ответ на каждый запрос отправляется код результата выполнения.
Номальный код выполнения `1000`. Это означает, что сервер корректно обработал запрос и смог сформировать ожидаемый ответ. Все описания результатов в документации описаны с учетом успешной обработки сервером. В случае ошибки, возвращается только два поля: `code`, `msg`. Расшифровку смотри в документе [Коды завершения](./errors.md).

Пример:

```javascript
{
  "code": 1101,
  "msg": "Not enough space"
}
```

## 4. Лимиты

Описание возможных лимитов по частоте использования методов API.

- На все запросы устанавливается ограничение в 50 з/с
- При превышении заданной частоты запросов сервер ответит кодом `429`

### 4.1. Частные лимиты

- В рамках одного IP не может быть более 10 з/с
- В рамках одного пользователя не может быть больше 10 з/с

## 5. Аутентификация запросов

Каждый запрос должен использовать `Basic authentication` c `ApiClientKey`и `ApiClientSecret` клиента в формате `base64(ApiClientKey:ApiClientSecret)`

Пример:

```https
Authorization: Basic NDIyNjoyNTBlNzBmYjgzYmIwYmI2YjJkYjkwMzYwZjI0YWUyMjhiM2I4Y2UyZTQyYjc1NGEzNDZhZGYyMmZhYzdkMjJl
```

## 6. Определения объектов API

### 6.1. Объект заказа

Имя            | Тип       | Обязательный | По умолчанию | Описание
-------------- | ----------| ------------ | ---------- |------------
`barcode`      | STRING    | YES |   | Уникальный идентификатор заказа. Генерируется на стороне клиента. Может представлять собой `Штриховой почтовый идентификатор`. Максимальный размер 128 символов.
`pin`          | INT       | YES |   | 5-ти значный уникальный пин-код заказа
`terminal_id`  | INT       | YES |   | Уникальный идентификатор терминала, которому принадлежит заказ
`status`       | INT       | YES |   | [Статус заказа](#62-статус-заказа)
`when_created` | STRING    | YES |   | Время создания заказа в формате ISO 8601: `YYYY-MM-DDTHH:MM:SSZ`
`when_updated` | STRING    | YES |   | Время последнего обновления статуса заказа в формате ISO 8601: `YYYY-MM-DDTHH:MM:SSZ`
`height`       | INT       | YES |   | Высота коробки в см.
`weight`       | INT       | NO  |   | Вес в граммах.
`period`       | INT       | NO  | 1 | Срок хранения заказа в сутках

### 6.2. Статус заказа

Заказы имеют следующие статусы:

- 10 - принят на хранение
- 20 - выдан
- 30 - просрочен
- 40 - просрочен, извлечен
- 50 - оформлено бронирование
- 60 - истек срок бронирования
- 70 - бронирование отменено

## 7. Методы API

### 7.1. Забронировать место для размещения заказа

```text
POST api/v1/terminals/{terminal_id}/orders/{barcode}
```

Каждый авторизованный пользователь может создать новый заказ. Это приведет к бронированию места под него. В терминале резервируется место, достаточное для размещения заказа, указанного размера.

**Параметры в URI**

Имя          | Тип     | Обязательный | По умолчанию | Описание
------------ | ------- | ------------ | ---------- |------------
`terminal_id`| INT     | YES | | Уникальный идентификатор терминала
`barcode`    | STRING  | YES | | Уникальный идентификатор заказа, может представлять собой `Штриховой почтовый идентификатор`. Максимальный размер 128 символов.

**Параметры в теле запроса**

Имя | Тип | Обязательный | По умолчанию | Описание
------------ | ------------ | ------------ | ---------- |------------
`height` | INT | YES | | Высота коробки в см. Максимальный размер не более 40 см.
`period` | INT | NO | 1 | Срок хранения заказа в сутках. Может принимать значение в диапазоне 1-14

**Результат**

Имя      | Тип    | Обязательный | По умолчанию | Описание
-------- | ------ | ------------ | ---------- |------------
`code`   | INT    | YES | | Результат выполнения запроса
`order`  | Object | YES | | [Объект заказа](#61-объект-заказа)

**Возможные коды ошибок**

- 1101 NO_SPACE
- 1102 NO_TERMINAL
- 1103 NO_FREE_TRAY
- 1104 MAX_HEIGHT_LIMIT
- 1105 INCORRECT_PERIOD
- 1106 INCORRECT_BARCODE

**Пример запроса**

`POST https://base_url/api/v1/terminals/999/orders/RB795731216SG`

```json
{
    "height": 20,
    "period": 4
}
```

**Пример успешного ответа**

```json
{
    
    "code": 1000, 
    "order": {
        "barcode": "RB795731216SG",
        "pin": 12345,
        "terminal_id": 999,
        "status": 50,
        "when_created": "2011-04-10T20:09:31Z",
        "when_updated": "2011-04-10T20:09:31Z",
        "height": 20,
        "period": 4
    }
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1101,
    "msg": "Not enough space"
}
```

### 7.2. Отменить размещение заказа

```text
DELETE api/v1/terminals/{terminal_id}/orders/{barcode}
```

Каждый авторизованный пользователь может отменить свое бронирование под заказ. Отменить можно заказ в статусе `оформлено бронирование`.

**Параметры в URI**

Имя          | Тип     | Обязательный | По умолчанию | Описание
------------ | ------- | ------------ | ------------ |------------
`terminal_id`| INT     | YES          | | Уникальный идентификатор терминала
`barcode`    | STRING  | YES          | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Результат**

Имя          | Тип | Обязательный | По умолчанию | Описание
------------ | --- | ------------ | ------------ |------------
`code`       | INT | YES          |              | Результат выполнения

**Возможные коды ошибок**

- 1001 NOT_FOUND
- 1002 WRONG_STATE
- 1102 NO_TERMINAL

**Пример запроса**

`DELETE https://base_url/api/v1/terminals/999/orders/RB795731216SG`

```json
{}
```

**Пример успешного ответа**

```json
{
    "code": 1000
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1001,
    "msg": "Order not found"
}
```

### 7.3. Забронировать место для возврата заказа

```text
POST api/v1/terminals/{terminal_id}/orders/{barcode}/return
```

Каждый авторизованный пользователь может забронировать место для возврата заказа.

**Параметры в URI**

Имя          | Тип | Обязательный | По умолчанию | Описание
------------ | ----| ------------ | ------------ |------------
`terminal_id`| INT | YES          | | Уникальный идентификатор терминала
`barcode`    | STRING  | YES      | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Параметры в теле запроса**

Имя      | Тип | Обязательный | По умолчанию | Описание
---------| --- | ------------ | ------------ |------------
`period` | INT | NO           | 1            | Срок брони в сутках. Может принимать значение в диапазоне 1-14

**Результат**

Имя         | Тип       | Обязательный | По умолчанию | Описание
----------- | ----------| ------------ | ------------ |------------
`code`      | INT       | YES | | Результат выполнения запроса
`order`     | Object    | YES | | [Объект заказа](#61-объект-заказа)

**Возможные коды ошибок**

- 1001 NOT_FOUND
- 1101 NO_SPACE
- 1102 NO_TERMINAL
- 1103 NO_FREE_TRAY
- 1105 INCORRECT_PERIOD

**Пример запроса**

`POST https://base_url/api/v1/terminals/999/orders/RB795731216SG/return`

```json
{
    "period": 2
}
```

**Пример успешного ответа**

```json
{
    "code": 1000, 
    "order": {
        "barcode": "RB795731216SG",
        "pin": 12345,
        "terminal_id": 999,
        "status": 50,
        "when_created": "2011-04-10T20:09:31Z",
        "when_updated": "2011-04-10T20:09:31Z",
        "height": 20,
        "weight": 222,
        "period": 4
    }
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1101,
    "msg": "Not enough space"
}
```

### 7.4. Отменить возврат

```text
DELETE api/v1/terminals/{terminal_id}/orders/{barcode}/return
```

Каждый авторизованный пользователь может отменить возврат.

**Параметры в URI**

Имя          | Тип | Обязательный | По умолчанию | Описание
------------ | ----| ------------ | ------------ |------------
`terminal_id`| INT | YES          | | Уникальный идентификатор терминала
`barcode`    | STRING | YES       | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Результат**

Имя          | Тип | Обязательный | По умолчанию | Описание
------------ | --- | ------------ | ------------ |------------
`code`       | INT | YES          |              | Результат выполнения

**Возможные коды ошибок**

- 1001 NOT_FOUND
- 1002 WRONG_STATE
- 1102 NO_TERMINAL

**Пример запроса**

`DELETE https://base_url/api/v1/terminals/999/orders/RB795731216SG/return`

```json
{}
```

**Пример успешного ответа**

```json
{
    "code": 1000
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1001,
    "msg": "Order not found"
}
```

### 7.5. Получить информацию о заказе

```text
GET api/v1/orders/{barcode}
```

Запрос возвращает объект заказа.

**Параметры в URI**

Имя         | Тип    | Обязательный | По умолчанию | Описание
----------- | ------ | ------------ | ------------ |------------
`barcode`   | STRING | YES          | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Результат**

Имя          | Тип       | Обязательный | По умолчанию | Описание
------------ | ----------| ------------ | ---------- |------------
`code`       | INT       | YES | | Результат выполнения запроса
`order`      | Object    | YES | | [Объект заказа](#61-объект-заказа)

**Возможные коды ошибок**

- 1001 NOT_FOUND

**Пример запроса**

`GET https://base_url/api/v1/orders/RB795731216SG`

**Пример успешного ответа**

```json
{
    "code": 1000, 
    "order": {
        "barcode": "RB795731216SG",
        "pin": 12345,
        "terminal_id": 999,
        "status": 50,
        "when_created": "2011-04-10T20:09:31Z",
        "when_updated": "2011-04-10T20:09:31Z",
        "height": 20,
        "weight": 222,
        "period": 4
    }
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1001,
    "msg": "Order not found"
}
```

### 7.6. Получить историю статусов заказа

```text
GET api/v1/orders/{barcode}/history
```

Запрос возвращает информацию об изменениях статуса заказа.

**Параметры в URI**

Имя         | Тип    | Обязательный | По умолчанию | Описание
----------- | ------ | ------------ | ------------ |------------
`barcode`   | STRING | YES          | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Результат**

Имя          | Тип       | Обязательный | По умолчанию | Описание
------------ | ----------| ------------ | ---------- |------------
`code`       | INT       | YES | | Результат выполнения запроса
`history`    | ARRAY     | YES | | Массив объектов истории

**Объект истории**

Имя            | Тип       | Обязательный | По умолчанию | Описание
-------------- | ----------| ------------ | ---------- |------------
`barcode`      | STRING    | YES |   | Уникальный идентификатор заказа.
`pin`          | INT       | YES |   | 5-ти значный уникальный пин-код заказа
`terminal_id`  | INT       | YES |   | Уникальный идентификатор терминала
`status`       | INT       | YES |   | [Статус заказа](#62-статус-заказа)
`when_updated` | STRING    | YES |   | Время обновления статуса заказа в формате ISO 8601: `YYYY-MM-DDTHH:MM:SSZ`
`height`       | INT       | YES |   | Высота коробки в см.
`weight`       | INT       | NO  |   | Вес в граммах.

**Возможные коды ошибок**

- 1001 NOT_FOUND

**Пример запроса**

`GET https://base_url/api/v1/orders/RB795731216SG/history`

**Пример успешного ответа**

```json
{
    "code": 1000, 
    "history": [
        {
            "barcode": "RB795731216SG",
            "pin": 12345,
            "terminal_id": 999,
            "status": 50,
            "when_updated": "2022-04-10T20:09:31Z",
            "height": 20,
            "weight": 222
        },
        {
            "barcode": "RB795731216SG",
            "pin": 12345,
            "terminal_id": 999,
            "status": 10,
            "when_updated": "2022-04-10T22:09:31Z",
            "height": 20,
            "weight": 222
        }
    ]
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1001,
    "msg": "Order not found"
}
```

### 7.7. Получить список заказов

```text
GET api/v1/orders
```

Запрос возвращает массив объектов заказов для данной учетной записи. Используется пагинация. Можно задать дополнительную фильтрацию, используя параметры запроса.

**Параметры в URI**

Имя          | Тип    | Обязательный | По умолчанию | Описание
------------ | ------ | ------------ | ------------ |------------
`status`     | STRING | NO           | `all` | Может принимать значения `all` - все заказы, `actual` - ожидающие получения клиентом, `expired` - просроченные клиентом, `booked` - для которых забронировано место, `returned` - возвращенные клиентом заказы
`since`      | STRING | NO           | now - 3 month| Вернуть только заказы, по которым были обновления статуса после заданного времени. Строка в формате ISO 8601: `YYYY-MM-DDTHH:MM:SSZ`. Если параметр `status` не равен `all`, значит учитываться будут обновления по выбранному статусу. Не может быть старше трех месяцев
`per_page`   | INT    | NO           | 30 | Количество объектов на одну страницу выдачи. Максимально 100
`page`       | INT    | NO           | 1 | Номер страницы для выборки результата

**Результат**

Массив объектов вида:

Имя          | Тип       | Обязательный | По умолчанию | Описание
------------ | ----------| ------------ | ---------- |------------
`code`       | INT       | YES | | Результат выполнения запроса
`orders`     | ARRAY     | NO  | | [Массив объектов заказа](#61-объект-заказа). Может отсутствовать, если ни один из заказов не подходит под условия запроса.

**Возможные коды ошибок**

- 1003 INVALID_PARAMS

**Пример запроса**

`GET https://base_url/api/v1/orders?status=all&per_page=30&page=1&since=2011-04-10T20:09:31Z`

**Пример успешного ответа**

```json
{
    "code": 1000,
    "orders": [
        {
            "barcode": "RB795731216SG",
            "pin": 12345,
            "terminal_id": 999,
            "status": 50,
            "when_created": "2011-04-10T20:09:31Z",
            "when_updated": "2011-04-10T20:09:31Z",
            "height": 20,
            "weight": 222,
            "period": 4
        },
        {
            "barcode": "RB1212121216SG",
            "pin": 12345,
            "terminal_id": 999,
            "status": 50,
            "when_created": "2011-04-10T20:09:31Z",
            "when_updated": "2011-04-10T20:09:31Z",
            "height": 20,
            "weight": 222,
            "period": 4
        }
    ]
}


```

**Пример неуспешного ответа**

```json
{
    "code": 1003,
    "msg": "Invalid params"
}
```
