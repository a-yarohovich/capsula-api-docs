# Публичное Rest API (28-05-2022)
<!-- TOC -->

- [1. Общая информация](#1-общая-информация)
- [2. Коды возврата HTTP](#2-коды-возврата-http)
- [3. Коды ошибок](#3-коды-ошибок)
- [4. Лимиты](#4-лимиты)
    - [4.1. Частные лимиты](#41-частные-лимиты)
- [5. Аутентификация запросов](#5-аутентификация-запросов)
- [6. Определения объектов API](#6-определения-объектов-api)
    - [6.1. Объект заказа](#61-объект-заказа)
        - [6.1.1. Статусы заказа](#611-статусы-заказа)
    - [6.2. Объект терминала](#62-объект-терминала)
- [7. Взаимодействие с партнерской системой](#7-взаимодействие-с-партнерской-системой)
- [8. Методы API](#8-методы-api)
    - [8.1. Бронирование места для размещения заказа](#81-бронирование-места-для-размещения-заказа)
    - [8.2. Отмена заказа или брони](#82-отмена-заказа-или-брони)
    - [8.3. Получить информацию о заказе](#83-получить-информацию-о-заказе)
    - [8.4. Получить историю изменений заказа](#84-получить-историю-изменений-заказа)
    - [8.5. Получить список заказов](#85-получить-список-заказов)
    - [8.6. Получить список терминалов](#86-получить-список-терминалов)
- [9. События API](#9-события-api)
    - [9.1. Изменение статуса заказа](#91-изменение-статуса-заказа)

<!-- /TOC -->

## 1. Общая информация

- Базовая точка доступа для API: **<https://api.capsula24.com/>**
- В ответе всегда возвращается объект `JSON`
- Для `GET` запросов параметры должны быть отправлены как `query string`.
- Для `POST`, `PUT`, and `DELETE` запросов параметры должны быть отправлены в теле запроса как JSON объект.
- Параметры могут быть отправлены в любом порядке.

## 2. Коды возврата HTTP

Описание возможных кодов возврата HTTP

- HTTP `401` Источник запроса не авторизован
- HTTP `4XX` используются для некорректных запросов, когда отправитель неверно его сформировал.
- HTTP `429` используется при достижении лимита по частоте запросов.
- HTTP `5XX` используется при проблемах на стороне API.

## 3. Коды ошибок

В ответ на каждый запрос отправляется код результата выполнения.
Номальный код выполнения `1000`. Это означает, что сервер корректно обработал запрос и смог сформировать ожидаемый ответ. Все описания результатов в документации описаны с учетом успешной обработки сервером. В случае ошибки, возвращается только два поля: `code`, `msg`. Расшифровку смотри в документе [Коды завершения](./errors.md).

Пример:

```javascript
{
  "code": 1101,
  "msg": "Not enough space"
}
```

## 4. Лимиты

Описание возможных лимитов по частоте использования методов API.

- На все запросы устанавливается ограничение в 40 з/с
- При превышении заданной частоты запросов сервер ответит кодом `429`

### 4.1. Частные лимиты

- В рамках одного IP не может быть более 10 з/с
- В рамках одного пользователя не может быть больше 10 з/с

## 5. Аутентификация запросов

Каждый запрос должен использовать `Basic authentication` c `ApiClientKey`и `ApiClientSecret` клиента в формате `base64(ApiClientKey:ApiClientSecret)`

Пример:

```https
Authorization: Basic NDIyNjoyNTBlNzBmYjgzYmIwYmI2YjJkYjkwMzYwZjI0YWUyMjhiM2I4Y2UyZTQyYjc1NGEzNDZhZGYyMmZhYzdkMjJl
```

## 6. Определения объектов API

### 6.1. Объект заказа

Имя             | Тип    | Обязательный | По умолчанию | Описание
--------------- | ------ | ------------ | ---------- |------------
`terminal_id`   | INT    | YES |   | Уникальный идентификатор терминала, которому принадлежит заказ
`barcode`       | STRING | YES |   | Уникальный идентификатор заказа. Генерируется на стороне клиента. Может представлять собой `Штриховой почтовый идентификатор`. Максимальный размер 128 символов
`status`        | STRING | YES |   | [Статусы заказа](#611-статусы-заказа)
`type`          | STRING | YES |   | Тип заказа. `Delivery` - доставка, `Return` - возврат
`client_pin`    | STRING | YES |   | 5-ти значный пин-код заказа для выдачи пользователю
`courier_pin`   | STRING | YES |   | 5-ти значный пин-код заказа для выдачи курьеру
`weight`        | INT    | NO  |   | Вес в граммах
`size1`         | INT    | YES |   | Одно из измерений размера в см.
`size2`         | INT    | YES |   | Одно из измерений размера в см.
`size3`         | INT    | YES |   | Одно из измерений размера в см.
`storage_period`| INT    | NO  | 1 | Срок хранения заказа в сутках
`value`         | INT    | NO  |   | Оценочная стоимость отправления в руб.
`summ`          | INT    | NO  |   | Сумма к оплате в руб.
`when_created`  | STRING | YES |   | Время создания заказа в формате ISO 8601: `YYYY-MM-DDTHH:MM:SSZ`

#### 6.1.1. Статусы заказа

Заказы имеют следующие статусы:

- `BookingRequest` : Заявка принята на сервере и ожидает подтверждения терминалом
- `BookingAccepted` : Бронирование подтверждено
- `BookingCancelRequest` : Терминал offline. Заявка на отмену принята сервером
- `BookingCancelled` : Бронирование отменено
- `InStorage` : Принят на хранение в терминале
- `StorageCancelRequest` : Терминал offline. Заявка на отмену заказа принята сервером
- `Cancelled` : Отменен и подлежит изъятию
- `Expired` : Заказ просрочен
- `Extracted` : Извлечен курьером
- `Delivered` : Выдан конечному пользователю

### 6.2. Объект терминала

Имя             | Тип    | Обязательный | По умолчанию | Описание
--------------- | ------ | ------------ | ---------- |------------
`terminal_id`   | INT    | YES |   | Уникальный идентификатор терминала, которому принадлежит заказ
`status`        | STRING | YES |   | `Active` - активен, `NotActive` - не активен, `Closed`- закрыт
`name`          | STRING | YES |   | Имя терминала, например `capsula-term-prod-N1`
`description`   | STRING | NO  |   | Описание терминала в свободной форме

## 7. Взаимодействие с партнерской системой

Для поддержки событий со стороны Capsula партнер должен предоставить свой базовый адрес в сети интернет, который будет использоваться для отправки событий в сторону партнера.
В этом документе, во всех примерах в качестве базового адреса внешней системы будет использоваться следующие базовый адрес: `https://external-system.com/vpbx/api/v1/`

## 8. Методы API

### 8.1. Бронирование места для размещения заказа

```text
POST api/v1/terminals/{terminal_id}/orders/{barcode}
```

Каждый авторизованный пользователь может создать новыю заявку на бронирование места в терминале. Это приведет к бронированию места под него сразу, если терминал доступен, иначе заявка будет принята и ожидать подтверждения терминалом. В терминале резервируется место, достаточное для размещения заказа, указанного размера. Если терминал не доступен прямо сейчас (например из-за обрыва соединения), подтверждение заявки придет в событии `onOrderChanged`

**Параметры в URI**

Имя          | Тип     | Обязательный | По умолчанию | Описание
------------ | ------- | ------------ | ---------- |------------
`terminal_id`| INT     | YES | | Уникальный идентификатор терминала
`barcode`    | STRING  | YES | | Уникальный идентификатор заказа, может представлять собой `Штриховой почтовый идентификатор`. Максимальный размер 128 символов.

**Параметры в теле запроса**

Имя             | Тип    | Обязательный | По умолчанию | Описание
--------------- | ------ | ------------ | ---------- |------------
`type`          | STRING | YES          | `Delivery` | Может принимать значения: `Delivery` - доставка, `Return` - возврат
`size1`         | INT    | YES          | | Первый размер коробки в см. Максимальный размер не более 40 см.
`size2`         | INT    | YES          | | Второй размер коробки в см. Максимальный размер не более 40 см.
`size3`         | INT    | YES          | | Третий размер коробки в см. Максимальный размер не более 40 см.
`weight`        | INT    | NO           | | Вес отправления в граммах
`value`         | INT    | YES          | | Оценочная стоимость отправления в руб.
`client_pin`    | STRING | YES          | | Код доступа клиента. Не пустая строка
`courier_pin`   | STRING | YES          | | Код доступа курьера. Не пустая строка
`storage_period`| INT    | NO           |1| Срок хранения заказа в сутках. Может принимать значение в диапазоне 1-14

**Результат**

Имя      | Тип    | Обязательный | По умолчанию | Описание
-------- | ------ | ------------ | ---------- |------------
`code`   | INT    | YES | | Результат выполнения запроса
`order`  | Object | YES | | [Объект заказа](#61-объект-заказа)

**Возможные коды ошибок**

- 1101 NO_SPACE
- 1102 NO_TERMINAL
- 1103 NO_FREE_TRAY
- 1104 SIZE_LIMIT
- 1105 INCORRECT_STORAGE_PERIOD
- 1106 INCORRECT_BARCODE
- 1107 INCORRECT_TYPE

**Пример запроса**

`POST https://base_url/api/v1/terminals/999/orders/RB795731216SG`

```json
{
    "type": "Delivery",
    "size1": 20,
    "size2": 30,
    "size3": 40,
    "weight": 100,
    "value": 1000,
    "client_pin": "54874",
    "courier_pin": "13434",
    "storage_period": 4
}
```

**Пример успешного ответа**

```json
{
    "code": 1000, 
    "order": {
        "terminal_id": 999,
        "barcode": "RB795731216SG",
        "status": "BookingAccepted",
        "type": "Delivery",
        "client_pin": "54874",
        "courier_pin": "13434",
        "size1": 20,
        "size2": 30,
        "size3": 40,
        "weight": 100,
        "value": 1000,
        "storage_period": 4,
        "when_created": "2011-04-10T20:09:31Z"
    }
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1101,
    "msg": "Not enough space"
}
```

### 8.2. Отмена заказа или брони

```text
DELETE api/v1/terminals/{terminal_id}/orders/{barcode}
```

Каждый авторизованный пользователь может отменить свое бронирование места под заказ или размещенный заказ. Работает только для случаев:  

- `BookingRequest` перейдет в `BookingCancelled`
- `BookingAccepted` перейдет в `BookingCancelled` или `BookingCancelRequest`
- `InStorage` перейдет в `Cancelled` или `StorageCancelRequest`

**Параметры в URI**

Имя          | Тип     | Обязательный | По умолчанию | Описание
------------ | ------- | ------------ | ------------ |------------
`terminal_id`| INT     | YES          | | Уникальный идентификатор терминала
`barcode`    | STRING  | YES          | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Результат**

Имя          | Тип | Обязательный | По умолчанию | Описание
------------ | --- | ------------ | ------------ |------------
`code`       | INT | YES          |              | Результат выполнения

**Возможные коды ошибок**

- 1001 NOT_FOUND
- 1002 WRONG_STATE
- 1102 NO_TERMINAL

**Пример запроса**

`DELETE https://base_url/api/v1/terminals/999/orders/RB795731216SG`

```json
{}
```

**Пример успешного ответа**

```json
{
    "code": 1000
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1001,
    "msg": "Order not found"
}
```

### 8.3. Получить информацию о заказе

```text
GET api/v1/orders/{barcode}
```

Запрос возвращает объект заказа.

**Параметры в URI**

Имя         | Тип    | Обязательный | По умолчанию | Описание
----------- | ------ | ------------ | ------------ |------------
`barcode`   | STRING | YES          | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Результат**

Имя          | Тип       | Обязательный | По умолчанию | Описание
------------ | ----------| ------------ | ---------- |------------
`code`       | INT       | YES | | Результат выполнения запроса
`order`      | Object    | YES | | [Объект заказа](#61-объект-заказа)

**Возможные коды ошибок**

- 1001 NOT_FOUND

**Пример запроса**

`GET https://base_url/api/v1/orders/RB795731216SG`

**Пример успешного ответа**

```json
{
    "code": 1000, 
    "order": {
        "terminal_id": 999,
        "barcode": "RB795731216SG",
        "status": "BookingAccepted",
        "type": "Delivery",
        "client_pin": "54874",
        "courier_pin": "13434",
        "size1": 20,
        "size2": 30,
        "size3": 40,
        "weight": 100,
        "value": 1000,
        "storage_period": 4,
        "when_created": "2011-04-10T20:09:31Z"
    }
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1001,
    "msg": "Order not found"
}
```

### 8.4. Получить историю изменений заказа

```text
GET api/v1/orders/{barcode}/history
```

Запрос возвращает информацию об изменениях статуса заказа.

**Параметры в URI**

Имя         | Тип    | Обязательный | По умолчанию | Описание
----------- | ------ | ------------ | ------------ |------------
`barcode`   | STRING | YES          | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Результат**

Имя          | Тип       | Обязательный | По умолчанию | Описание
------------ | ----------| ------------ | ---------- |------------
`code`       | INT       | YES | | Результат выполнения запроса
`history`    | ARRAY     | YES | | Массив исторических данных заказа. Поля те же, что и в [Объекте заказа](#61-объект-заказа). Поле `when_created` обозначает время изменения заказа

**Возможные коды ошибок**

- 1001 NOT_FOUND

**Пример запроса**

`GET https://base_url/api/v1/orders/RB795731216SG/history`

**Пример успешного ответа**

```json
{
    "code": 1000, 
    "history": [
        {
            "terminal_id": 999,
            "barcode": "RB795731216SG",
            "status": "BookingAccepted",
            "type": "Delivery",
            "client_pin": "54874",
            "courier_pin": "13434",
            "size1": 20,
            "size2": 30,
            "size3": 40,
            "weight": 100,
            "value": 1000,
            "storage_period": 4,
            "when_created": "2022-04-10T20:09:31Z"
        },
        {
            "terminal_id": 999,
            "barcode": "RB795731216SG",
            "status": "InStorage",
            "type": "Delivery",
            "client_pin": "54874",
            "courier_pin": "13434",
            "size1": 20,
            "size2": 30,
            "size3": 40,
            "weight": 100,
            "value": 1000,
            "storage_period": 4,
            "when_created": "2022-04-11T21:09:31Z"
        }
    ]
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1001,
    "msg": "Order not found"
}
```

### 8.5. Получить список заказов

```text
GET api/v1/orders
```

Запрос возвращает массив объектов заказов для данной учетной записи. Используется пагинация. Можно задать дополнительную фильтрацию, используя параметры запроса.

**Параметры в URI**

Имя          | Тип    | Обязательный | По умолчанию | Описание
------------ | ------ | ------------ | ------------ |------------
`status`     | STRING | NO           | | Если не задан - выдать все заказы либо конкретный [Статус](#611-статусы-заказа), тогда в выдаче будут заказы только с этим статусом
`since`      | STRING | NO           | now - 3 month| Вернуть только заказы, по которым были обновления статуса после заданного времени. Строка в формате ISO 8601: `YYYY-MM-DDTHH:MM:SSZ`. Если параметр `status` не равен `all`, значит учитываться будут обновления по выбранному статусу. Не может быть старше трех месяцев
`per_page`   | INT    | NO           | 30 | Количество объектов на одну страницу выдачи. Максимально 100
`page`       | INT    | NO           | 1 | Номер страницы для выборки результата

**Результат**

Массив объектов вида:

Имя          | Тип       | Обязательный | По умолчанию | Описание
------------ | ----------| ------------ | ---------- |------------
`code`       | INT       | YES | | Результат выполнения запроса
`orders`     | ARRAY     | NO  | | [Массив объектов заказа](#61-объект-заказа). Может отсутствовать, если ни один из заказов не подходит под условия запроса.

**Возможные коды ошибок**

- 1003 INVALID_PARAMS

**Пример запроса**

`GET https://base_url/api/v1/orders?status=BookingAccepted&per_page=30&page=1&since=2011-04-10T20:09:31Z`

**Пример успешного ответа**

```json
{
    "code": 1000,
    "orders": [
        {
            "terminal_id": 999,
            "barcode": "RB795731216SG",
            "status": "BookingAccepted",
            "type": "Delivery",
            "client_pin": "54874",
            "courier_pin": "13434",
            "size1": 20,
            "size2": 30,
            "size3": 40,
            "weight": 100,
            "value": 1000,
            "storage_period": 4,
            "when_created": "2022-04-10T20:09:31Z"
        },
        {
            "terminal_id": 222,
            "barcode": "RR795336SG",
            "status": "BookingAccepted",
            "type": "Delivery",
            "client_pin": "54874",
            "courier_pin": "13434",
            "size1": 20,
            "size2": 30,
            "size3": 40,
            "weight": 100,
            "value": 2000,
            "storage_period": 2,
            "when_created": "2022-04-11T21:09:31Z"
        }
    ]
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1003,
    "msg": "Invalid params"
}
```

### 8.6. Получить список терминалов

```text
GET api/v1/terminals
```

Запрос возвращает массив объектов терминалов, доступных для данной учетной записи. Используется пагинация.

**Параметры в URI**

Имя          | Тип    | Обязательный | По умолчанию | Описание
------------ | ------ | ------------ | ------------ |------------
`per_page`   | INT    | NO           | 30 | Количество объектов на одну страницу выдачи. Максимально 100
`page`       | INT    | NO           | 1 | Номер страницы для выборки результата

**Результат**

Массив объектов вида:

Имя          | Тип       | Обязательный | По умолчанию | Описание
------------ | ----------| ------------ | ---------- |------------
`code`       | INT       | YES | | Результат выполнения запроса
`terminals`  | ARRAY     | NO  | | Массив [Объектов терминала](#62-объект-терминала)

**Возможные коды ошибок**

- 1003 INVALID_PARAMS

**Пример запроса**

`GET https://base_url/api/v1/terminals?per_page=30&page=1`

**Пример успешного ответа**

```json
{
    "code": 1000,
    "terminals": [
        {
           "terminal_id": 232,
           "status": "Active",      
           "name": "capsula-term-prod-N1"
        },
        {
          "terminal_id": 999,
           "status": "Active",      
           "name": "capsula-term-prod-N2"
        }
    ]
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1003,
    "msg": "Invalid params"
}
```

## 9. События API

### 9.1. Изменение статуса заказа

```text
POST /events/order
```

Событие вызывается на стороне партнерского АПИ и сигнализирует о смене состояния заказа.
//TODO расписать
