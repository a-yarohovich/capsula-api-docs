# Публичное Rest API (26-05-2022)
<!-- TOC -->

- [1. Общая информация](#1-общая-информация)
- [2. Коды возврата HTTP](#2-коды-возврата-http)
- [3. Коды ошибок](#3-коды-ошибок)
- [4. Лимиты](#4-лимиты)
    - [4.1. Частные лимиты](#41-частные-лимиты)
- [5. Аутентификация запросов](#5-аутентификация-запросов)
- [6. Определение перечислений](#6-определение-перечислений)
    - [6.1. Статус заказа](#61-статус-заказа)
- [7. Методы API](#7-методы-api)
    - [7.1. Забронировать место для размещения заказа](#71-забронировать-место-для-размещения-заказа)
    - [7.2. Отменить размещение заказа](#72-отменить-размещение-заказа)
    - [7.3. Забронировать место для возврата заказа](#73-забронировать-место-для-возврата-заказа)
    - [7.4. Отменить возврат](#74-отменить-возврат)

<!-- /TOC -->

## 1. Общая информация

- Базовая точка доступа для API: **<https://api.capsula24.com/>**
- В ответе всегда возвращается объект `JSON`
- Для `GET` запросов параметры должны быть отправлены как `query string`.
- Для `POST`, `PUT`, and `DELETE` запросов параметры должны быть отправлены в теле запроса как JSON объект.
- Параметры могут быть отправлены в любом порядке.

## 2. Коды возврата HTTP

Описание возможных кодов возврата HTTP

- HTTP `401` Источник запроса не авторизован
- HTTP `4XX` используются для некорректных запросов, когда отправитель неверно его сформировал.
- HTTP `429` используется при достижении лимита по частоте запросов.
- HTTP `5XX` используется при проблемах на стороне API.

## 3. Коды ошибок

В ответ на каждый запрос отправляется код результата выполнения.
Номальный код выполнения `1000`. Это означает, что сервер корректно обработал запрос и смог сформировать ожидаемый ответ. Все описания результатов в документации описаны с учетом успешной обработки сервером. В случае ошибки, возвращается только два поля: `code`, `msg`. Расшифровку смотри в документе [Коды завершения](./errors.md).

Пример:

```javascript
{
  "code": 1101,
  "msg": "Not enough space"
}
```

## 4. Лимиты

Описание возможных лимитов по частоте использования методов API.

- На все запросы устанавливается ограничение в 50 з/с
- При превышении заданной частоты запросов сервер ответит кодом `429`

### 4.1. Частные лимиты

- В рамках одного IP не может быть более 10 з/с
- В рамках одного пользователя не может быть больше 10 з/с

## 5. Аутентификация запросов

Каждый запрос должен использовать `Basic authentication` c `ClientID`и `SecretKey` клиента в формате `base64(ClientID:SecretKey)`

Пример:

```https
Authorization: Basic NDIyNjoyNTBlNzBmYjgzYmIwYmI2YjJkYjkwMzYwZjI0YWUyMjhiM2I4Y2UyZTQyYjc1NGEzNDZhZGYyMmZhYzdkMjJl
```

## 6. Определение перечислений

### 6.1. Статус заказа

Заказы имеют следующие статусы:

- 10 - принят на хранение
- 20 - выдан
- 30 - просрочен
- 40 - просрочен, извлечен
- 50 - оформлено бронирование
- 60 - истек срок бронирования
- 70 - бронирование отменено

## 7. Методы API

### 7.1. Забронировать место для размещения заказа

```text
POST /api/v1/terminals/{terminal_id}/orders/{order_id}
```

Каждый авторизованный пользователь может создать новый заказ. Это приведет к бронированию места под него. В терминале резервируется место, достаточное для размещения заказа, указанного размера.

**Параметры в URI**

Имя          | Тип     | Обязательный | По умолчанию | Описание
------------ | ------- | ------------ | ---------- |------------
`terminal_id`| INT     | YES | | Уникальный идентификатор терминала
`order_id`   | STRING  | YES | | Уникальный идентификатор заказа, может представлять собой `Штриховой почтовый идентификатор`. Максимальный размер 128 символов.

**Параметры в теле запроса**

Имя | Тип | Обязательный | По умолчанию | Описание
------------ | ------------ | ------------ | ---------- |------------
`box_height` | INT | YES | | Высота коробки в см. Максимальный размер не более 40 см.
`period` | INT | NO | 1 | Срок хранения заказа в сутках. Может принимать значение в диапазоне 1-14

**Результат**

Имя          | Тип       | Обязательный | По умолчанию | Описание
------------ | ----------| ------------ | ---------- |------------
`order_id`   | STRING    | YES | | Уникальный идентификатор заказа, полученный в параметрах запроса.
`code`       | INT       | YES | | Результат выполнения запроса
`pin`        | INT       | YES | | 5-ти значный уникальный пин-код заказа
`status`     | INT       | YES | | [Статус заказа](#61-статус-заказа)
`datetime`   | TIMESTAMP | YES | | Дата и время бронирования в формате timestamp
`period`     | INT       | YES | | Срок хранения заказа

**Возможные коды ошибок**

- 1101 NO_SPACE
- 1102 NO_TERMINAL
- 1103 NO_FREE_TRAY
- 1104 MAX_HEIGHT_LIMIT
- 1105 INCORRECT_PERIOD
- 1106 INCORRECT_ORDER_ID

**Пример запроса**

`POST https://base_url/api/v1/terminals/999/orders/RB795731216SG`

```json
{
    "box_height": 20,
    "period": 4
}
```

**Пример успешного ответа**

```json
{
    "order_id": "RB795731216SG",
    "code": 1000, 
    "pin": 12345,
    "status": 50,
    "datetime": 1653553048,
    "period": 4
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1101,
    "msg": "Not enough space"
}
```

### 7.2. Отменить размещение заказа

```text
DELETE /api/v1/terminals/{terminal_id}/orders/{order_id}
```

Каждый авторизованный пользователь может отменить свое бронирование под заказ.
Отменить можно заказ в статусе `оформлено бронирование`.

**Параметры в URI**

Имя          | Тип     | Обязательный | По умолчанию | Описание
------------ | ------- | ------------ | ------------ |------------
`terminal_id`| INT     | YES          | | Уникальный идентификатор терминала
`order_id`   | STRING  | YES          | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Результат**

Имя          | Тип | Обязательный | По умолчанию | Описание
------------ | --- | ------------ | ------------ |------------
`code`       | INT | YES          |              | Результат выполнения

**Возможные коды ошибок**

- 1001 NOT_FOUND
- 1002 WRONG_STATE
- 1102 NO_TERMINAL

**Пример запроса**

`DELETE https://base_url/api/v1/terminals/999/orders/RB795731216SG`

```json
{}
```

**Пример успешного ответа**

```json
{
    "code": 1000
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1001,
    "msg": "Order not found"
}
```

### 7.3. Забронировать место для возврата заказа

```text
POST /api/v1/terminals/{terminal_id}/orders/{order_id}/return
```

Каждый авторизованный пользователь может забронировать место для возврата заказа.

**Параметры в URI**

Имя          | Тип | Обязательный | По умолчанию | Описание
------------ | ----| ------------ | ------------ |------------
`terminal_id`| INT | YES          | | Уникальный идентификатор терминала
`order_id`   | STRING  | YES      | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Параметры в теле запроса**

Имя      | Тип | Обязательный | По умолчанию | Описание
---------| --- | ------------ | ------------ |------------
`period` | INT | NO           | 1            | Срок хранения заказа в сутках. Может принимать значение в диапазоне 1-14

**Результат**

Имя         | Тип       | Обязательный | По умолчанию | Описание
----------- | ----------| ------------ | ------------ |------------
`order_id`  | STRING    | YES          | | Уникальный идентификатор заказа
`code`      | INT       | YES          | | Результат выполнения запроса
`pin`       | INT       | YES          | | 5-ти значный уникальный пин-код заказа
`status`    | INT       | YES          | | [Статус заказа](#61-статус-заказа)
`datetime`  | TIMESTAMP | YES          | | Дата и время бронирования в формате timestamp
`period`    | INT       | YES          | | Срок размещения в сутках

**Возможные коды ошибок**

- 1001 NOT_FOUND
- 1101 NO_SPACE
- 1102 NO_TERMINAL
- 1103 NO_FREE_TRAY
- 1105 INCORRECT_PERIOD

**Пример запроса**

`POST https://base_url/api/v1/terminals/999/orders/RB795731216SG/return`

```json
{
    "period": 2
}
```

**Пример успешного ответа**

```json
{
    "order_id": "RB795731216SG",
    "code": 1000, 
    "pin": 12345,
    "status": 50,
    "datetime": 1653553048,
    "period": 2
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1101,
    "msg": "Not enough space"
}
```

### 7.4. Отменить возврат

```text
DELETE /api/v1/terminals/{terminal_id}/orders/{order_id}/return
```

Каждый авторизованный пользователь может отменить возврат.

**Параметры в URI**

Имя          | Тип | Обязательный | По умолчанию | Описание
------------ | ----| ------------ | ------------ |------------
`terminal_id`| INT | YES          | | Уникальный идентификатор терминала
`order_id`   | STRING | YES       | | Уникальный идентификатор заказа. Максимальный размер 128 символов

**Результат**

Имя          | Тип | Обязательный | По умолчанию | Описание
------------ | --- | ------------ | ------------ |------------
`code`       | INT | YES          |              | Результат выполнения

**Возможные коды ошибок**

- 1001 NOT_FOUND
- 1002 WRONG_STATE
- 1102 NO_TERMINAL

**Пример запроса**

`DELETE https://base_url/api/v1/terminals/999/orders/RB795731216SG/return`

```json
{}
```

**Пример успешного ответа**

```json
{
    "code": 1000
}
```

**Пример неуспешного ответа**

```json
{
    "code": 1001,
    "msg": "Order not found"
}
```
